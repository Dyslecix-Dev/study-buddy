generator client {
  provider = "prisma-client"
  output = "../app/generated/prisma"
  generatedFileExtension = "ts"
  importFileExtension    = "ts"
}

datasource db {
  provider = "postgresql"
}

model Deck {
  id          String      @id @default(uuid())
  name        String
  description String?
  color       String?
  userId      String
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  User        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  Flashcard   Flashcard[]

  @@unique([userId, name])
  @@index([userId])
}

model Flashcard {
  id           String    @id @default(uuid())
  front        Json
  back         Json
  deckId       String
  easeFactor   Float     @default(2.5)
  interval     Int       @default(0)
  repetitions  Int       @default(0)
  nextReview   DateTime?
  lastReviewed DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  Deck         Deck      @relation(fields: [deckId], references: [id], onDelete: Cascade)
  Review       Review[]
  Tag          Tag[]

  @@index([deckId])
  @@index([nextReview])
}

model Folder {
  id          String   @id @default(uuid())
  name        String
  color       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  description String?
  userId      String
  User        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  Note        Note[]

  @@unique([userId, name])
  @@index([userId])
}

model Note {
  id                                 String     @id @default(uuid())
  title                              String
  content                            Json
  userId                             String
  folderId                           String?
  createdAt                          DateTime   @default(now())
  updatedAt                          DateTime   @updatedAt
  Folder                             Folder?    @relation(fields: [folderId], references: [id])
  User                               User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  NoteLink_NoteLink_fromNoteIdToNote NoteLink[] @relation("NoteLink_fromNoteIdToNote")
  NoteLink_NoteLink_toNoteIdToNote   NoteLink[] @relation("NoteLink_toNoteIdToNote")
  Tag                                Tag[]

  @@unique([userId, title])
  @@index([folderId])
  @@index([userId, createdAt])
  @@index([userId])
}

model NoteLink {
  id                             String   @id @default(uuid())
  fromNoteId                     String
  toNoteId                       String
  createdAt                      DateTime @default(now())
  Note_NoteLink_fromNoteIdToNote Note     @relation("NoteLink_fromNoteIdToNote", fields: [fromNoteId], references: [id], onDelete: Cascade)
  Note_NoteLink_toNoteIdToNote   Note     @relation("NoteLink_toNoteIdToNote", fields: [toNoteId], references: [id], onDelete: Cascade)

  @@unique([fromNoteId, toNoteId])
  @@index([fromNoteId])
  @@index([toNoteId])
}

model Review {
  id          String    @id @default(uuid())
  flashcardId String
  quality     Int
  createdAt   DateTime  @default(now())
  Flashcard   Flashcard @relation(fields: [flashcardId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([flashcardId])
}

model StudySession {
  id        String    @id @default(uuid())
  userId    String
  duration  Int
  type      String
  completed Boolean   @default(false)
  startedAt DateTime  @default(now())
  endedAt   DateTime?
  User      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, startedAt])
}

model Tag {
  id        String      @id @default(uuid())
  name      String
  color     String?
  userId    String?
  createdAt DateTime    @default(now())
  User      User?       @relation(fields: [userId], references: [id], onDelete: Cascade)
  Flashcard Flashcard[]
  Note      Note[]
  Task      Task[]
  Question  Question[]

  @@index([userId])
  @@index([name])
}

model Task {
  id          String    @id @default(uuid())
  title       String
  description String?
  completed   Boolean   @default(false)
  dueDate     DateTime?
  startTime   DateTime?
  endTime     DateTime?
  priority    Int       @default(0)
  order       Int       @default(0)
  userId      String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  User        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  Tag         Tag[]

  @@index([userId, completed])
  @@index([userId, dueDate])
  @@index([userId, startTime])
  @@index([userId])
}

model FocusSession {
  id          String   @id @default(uuid())
  userId      String
  mode        String
  duration    Int
  completedAt DateTime @default(now())
  User        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, completedAt])
}

model DailyProgress {
  id                      String   @id @default(uuid())
  userId                  String
  date                    DateTime
  tasksCompleted          Int      @default(0)
  cardsReviewed           Int      @default(0)
  notesCreated            Int      @default(0)
  notesUpdated            Int      @default(0)
  focusMinutes            Int      @default(0)
  examsCompleted          Int      @default(0)
  questionsCreated        Int      @default(0)
  questionsAnswered       Int      @default(0)
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
  User                    User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId, date])
  @@index([userId])
}

model ActivityLog {
  id          String   @id @default(uuid())
  userId      String
  type        String   // 'note_created', 'note_updated', 'note_deleted', 'task_created', 'task_completed', etc.
  entityType  String   // 'note', 'task', 'folder', 'deck', 'flashcard', 'focus_session'
  entityId    String?  // ID of the related entity (nullable for deleted items)
  title       String   // Display title for the activity
  metadata    Json?    // Additional data (e.g., duration for focus sessions, folder name, etc.)
  createdAt   DateTime @default(now())
  User        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([userId])
}

model Exam {
  id          String        @id @default(uuid())
  name        String
  description String?
  color       String?
  userId      String
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  User        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  Question    Question[]
  ExamAttempt ExamAttempt[]

  @@unique([userId, name])
  @@index([userId])
}

model Question {
  id             String           @id @default(uuid())
  question       String
  questionType   String           // 'multiple_choice', 'select_all', 'true_false'
  options        Json             // Array of options with { text: string, isCorrect: boolean }
  examId         String
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  Exam           Exam             @relation(fields: [examId], references: [id], onDelete: Cascade)
  Tag            Tag[]
  QuestionResult QuestionResult[]

  @@index([examId])
}

model ExamAttempt {
  id             String           @id @default(uuid())
  examId         String
  userId         String
  score          Int              // Percentage score 0-100
  totalQuestions Int
  correctAnswers Int
  startedAt      DateTime         @default(now())
  completedAt    DateTime?
  Exam           Exam             @relation(fields: [examId], references: [id], onDelete: Cascade)
  User           User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  QuestionResult QuestionResult[]

  @@index([examId])
  @@index([userId])
  @@index([userId, completedAt])
}

model QuestionResult {
  id            String      @id @default(uuid())
  attemptId     String
  questionId    String
  userAnswer    Json        // Array of selected option indices or boolean
  isCorrect     Boolean
  createdAt     DateTime    @default(now())
  ExamAttempt   ExamAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  Question      Question    @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([attemptId])
  @@index([questionId])
}

model User {
  id               String             @id
  email            String             @unique
  name             String?
  image            String?
  emailVerified    DateTime?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  ActivityLog      ActivityLog[]
  DailyProgress    DailyProgress[]
  Deck             Deck[]
  Exam             Exam[]
  ExamAttempt      ExamAttempt[]
  Folder           Folder[]
  FocusSession     FocusSession[]
  Note             Note[]
  StudySession     StudySession[]
  Tag              Tag[]
  Task             Task[]
  UserProgress     UserProgress?
  UserAchievement  UserAchievement[]

  @@index([email])
}

model UserProgress {
  id              String   @id @default(uuid())
  userId          String   @unique
  totalXP         Int      @default(0)
  level           Int      @default(1)
  currentStreak   Int      @default(0)
  longestStreak   Int      @default(0)
  lastActiveDate  DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Cumulative counters (never decrease, even when items are deleted)
  totalNotesCreated      Int @default(0)
  totalFoldersCreated    Int @default(0)
  totalTagsUsed          Int @default(0)
  totalTasksCreated      Int @default(0)
  totalDecksCreated      Int @default(0)
  totalExamsCreated      Int @default(0)
  totalQuestionsCreated  Int @default(0)
  totalLinksCreated      Int @default(0)

  // Flashcard review streak tracking
  currentReviewStreak    Int @default(0)
  longestReviewStreak    Int @default(0)

  // Task tracking
  earlyTaskCompletions   Int @default(0)

  User            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([totalXP])
  @@index([level])
}

model Achievement {
  id              String            @id @default(uuid())
  key             String            @unique // e.g., "first-note", "study-streak-7"
  name            String            // Display name
  description     String            // What the achievement is for
  icon            String            // Emoji or icon identifier
  xpReward        Int               @default(0)
  category        String            // e.g., "notes", "tasks", "study", "streak"
  requirement     Int?              // Numeric requirement (e.g., 7 for 7-day streak)
  tier            String            @default("bronze") // bronze, silver, gold, platinum
  createdAt       DateTime          @default(now())
  UserAchievement UserAchievement[]

  @@index([category])
  @@index([tier])
}

model UserAchievement {
  id            String      @id @default(uuid())
  userId        String
  achievementId String
  unlockedAt    DateTime    @default(now())
  User          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  Achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@index([userId])
  @@index([achievementId])
  @@index([userId, unlockedAt])
}
